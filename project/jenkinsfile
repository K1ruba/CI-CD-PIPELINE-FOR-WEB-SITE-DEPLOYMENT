pipeline {
    agent any

    environment {
        // DOCKERHUB_CREDENTIALS = credentials('dockerhub-cred')  // Jenkins credential
        DOCKERHUB_USERNAME = 'venkateshvgs'
        IMAGE_TAG = "${BUILD_NUMBER}"
    }

    stages {
        stage('Checkout') {
            steps {
                git url: 'https://github.com/VenkatVGS/k8s-helm.git'
            }
        }
        stage('Build Backend Image') {
            steps {
                dir('project/backend') {
                    sh "docker build -t $DOCKERHUB_USERNAME/backend-123:${IMAGE_TAG} ."
                }
            }
        }
        stage('Build Frontend Image') {
            steps {
                dir('project/frontend') {
                    sh "docker build -t $DOCKERHUB_USERNAME/frontend-123:${IMAGE_TAG} ."
                }
            }
        }
        stage('Docker Push') {
            steps {
                script {
                    withCredentials([string(credentialsId: 'dockerpass', variable: 'dockerPassword')]) {
                        sh "docker login -u $DOCKERHUB_USERNAME -p ${dockerPassword}"
                        sh "docker push $DOCKERHUB_USERNAME/backend-123:${IMAGE_TAG}"
                        sh "docker push $DOCKERHUB_USERNAME/frontend-123:${IMAGE_TAG}"
                    }
                }
            }
        }
        stage('Deploy on k8s') {
            steps {
                script {
                    withKubeCredentials(kubectlCredentials: [[ credentialsId: 'kubernetes' ]]) {
                        sh "kubectl apply -f project/k8s/db-deployment.yaml"
                        sh "kubectl apply -f project/k8s/backend-deployment.yaml"
                        sh "kubectl apply -f project/k8s/frontend-deployment.yaml"

                        // Set the new images for backend and frontend
                        sh "kubectl set image deployment/backend backend=$DOCKERHUB_USERNAME/backend-123:${IMAGE_TAG}"
                        sh "kubectl set image deployment/frontend frontend=$DOCKERHUB_USERNAME/frontend-123:${IMAGE_TAG}"
                    }
                }
            }
        }
    }
}
